<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Annotations</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
<header>
    <div class="logo">Legal AI Assistant</div>
    <nav>
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('index') }}">Entities</a>
        <a href="{{ url_for('extract_structure') }}">Structure</a>
        <a href="{{ url_for('parse_decision_route') }}">Decision</a>
        <a href="{{ url_for('run_query') }}">SQL</a>
        <a href="{{ url_for('view_legislation') }}">Moroccan Legislation</a>
    </nav>
</header>
<main class="container">
    <h1>Edit Annotations - {{ file }}</h1>
    {% if error %}<p style="color:red">{{ error }}</p>{% endif %}

    <div id="text-display" class="card"><div id="json-tree" dir="rtl"></div></div>

    <h2>Operations</h2>
    <form id="add-form" method="post" class="inline-form">
        <input type="hidden" name="action" value="add" />
        <label>Start <input id="add-start" name="start" size="4" /></label>
        <label>End <input id="add-end" name="end" size="4" /></label>
        <label>Type <input name="type" size="6" /></label>
        <label>Norm <input name="norm" size="8" /></label>
        <button type="submit" class="button">Add</button>
    </form>

    <form id="update-form" method="post" class="inline-form">
        <input type="hidden" name="action" value="update" />
        <label>ID <input id="upd-id" name="id" size="6" /></label>
        <label>Type <input id="upd-type" name="type" size="6" /></label>
        <label>Norm <input id="upd-norm" name="norm" size="8" /></label>
        <label>Start 
            <button type="button" class="button small nudge-start" data-delta="-1">&lt;</button>
            <input id="upd-start" name="start" size="4" />
            <button type="button" class="button small nudge-start" data-delta="1">&gt;</button>
        </label>
        <label>End 
            <button type="button" class="button small nudge-end" data-delta="-1">&lt;</button>
            <input id="upd-end" name="end" size="4" />
            <button type="button" class="button small nudge-end" data-delta="1">&gt;</button>
        </label>
        <button type="submit" class="button">Update</button>
    </form>

    <form id="replace-form" method="post" class="inline-form">
        <input type="hidden" name="action" value="replace" />
        <label>Start <input id="rep-start" name="start" size="4" /></label>
        <label>End <input id="rep-end" name="end" size="4" /></label>
        <label>Text <input id="rep-text" name="text" size="10" /></label>
        <button type="submit" class="button">Replace Text</button>
    </form>

    <form method="post" class="inline-form">
        <input type="hidden" name="action" value="fix" />
        <button type="submit" class="button">Fix Offsets</button>
        <a href="{{ url_for('view_legislation', file=file) }}" class="button">Back</a>
    </form>

    <h2>Entities</h2>
    <table id="entity-table">
        <thead>
            <tr><th>ID</th><th>Type</th><th>Text</th><th>Actions</th></tr>
        </thead>
        <tbody>
        {% for e in entities %}
            <tr data-id="{{ e.id }}" data-type="{{ e.type }}" data-norm="{{ e.normalized }}" data-start="{{ e.start_char }}" data-end="{{ e.end_char }}">
                <td>{{ e.id }}</td>
                <td>{{ e.type }}</td>
                <td>{{ e.text }}</td>
                <td>
                    <form method="post" class="inline-form">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="id" value="{{ e.id }}" />
                        <button type="submit" class="button small">Delete</button>
                    </form>
                    <button type="button" class="button small edit-entity">Edit</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h2>Raw Content</h2>
    <form method="post">
        <input type="hidden" name="action" value="save" />
        <textarea name="content" rows="10" style="width:100%">{{ raw }}</textarea>
        <button type="submit" class="button">Save</button>
    </form>
</main>
<script>
    const data = {{ data | tojson }};
    const entitiesData = {{ entities | tojson }};
    const entityMap = {};
    entitiesData.forEach(e => { entityMap[e.id] = e; });

    function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function formatText(value) {
        if (typeof value !== 'string') return escapeHtml(value);
        return value.replace(/<([^,<>]+), id:(\d+)>/g, (_m, txt, id) => {
            const ent = entityMap[id] || {};
            const attrs = [`class=\"entity-mark\"`,`data-id=\"${id}\"`,`data-start=\"${ent.start_char || 0}\"`,`data-end=\"${ent.end_char || 0}\"`];
            if (ent.type) attrs.push(`data-type=\"${escapeHtml(ent.type)}\"`);
            if (ent.normalized) attrs.push(`data-norm=\"${escapeHtml(ent.normalized)}\"`);
            return `<span ${attrs.join(' ')}>${escapeHtml(txt)}</span>`;
        });
    }

    function renderNode(node, container) {
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.classList.add('json-key');
        let label = '';
        if (node.type) label += escapeHtml(node.type);
        if (node.number) label += (label ? ' ' : '') + escapeHtml(node.number);
        if (node.title) label += (label ? ': ' : '') + formatText(node.title);
        summary.innerHTML = label;
        details.appendChild(summary);

        if (node.text) {
            const textDiv = document.createElement('div');
            textDiv.className = 'json-value';
            textDiv.innerHTML = formatText(node.text);
            details.appendChild(textDiv);
        }

        if (Array.isArray(node.children) && node.children.length) {
            const ul = document.createElement('ul');
            node.children.forEach(child => {
                const li = document.createElement('li');
                renderNode(child, li);
                ul.appendChild(li);
            });
            details.appendChild(ul);
        }
        container.appendChild(details);
    }

    function render(container, obj) {
        if (Array.isArray(obj)) {
            const ul = document.createElement('ul');
            obj.forEach(item => {
                const li = document.createElement('li');
                renderNode(item, li);
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else if (obj && typeof obj === 'object') {
            renderNode(obj, container);
        }
    }

    if (data) {
        render(document.getElementById('json-tree'), data);
    }
</script>
<script src="{{ url_for('static', filename='annotations.js') }}"></script>
</body>
</html>
