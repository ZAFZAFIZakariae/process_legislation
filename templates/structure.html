{% extends "base.html" %}
{% block title %}Structure Pipeline{% endblock %}
{% block content %}
<h1>Chunking &amp; Post-processing</h1>
<form class="card" action="{{ url_for('extract_structure') }}" method="post" enctype="multipart/form-data">
    <label>Upload PDF or text file:
        <input type="file" name="file" required />
    </label>
    <button type="submit">Run Pipeline</button>
</form>
{% if error %}
<section class="card">
    <p>{{ error }}</p>
</section>
{% endif %}
{% if result %}
<section class="card">
    <h2>Result</h2>
    <div id="json-tree" class="json-tree"></div>
    <a class="button" href="{{ url_for('view_legislation', file=saved_file) }}">Open saved file</a>
    <a class="button" href="data:application/json;charset=utf-8,{{ result | tojson | urlencode }}" download="{{ saved_file }}">Download {{ saved_file }}</a>
</section>
{% endif %}
{% endblock %}
{% block scripts %}
{% if result %}
<script>
const data = {{ result | tojson }};
function render(container, obj) {
    if (Array.isArray(obj)) {
        const ul = document.createElement('ul');
        obj.forEach(item => {
            const li = document.createElement('li');
            render(li, item);
            ul.appendChild(li);
        });
        container.appendChild(ul);
    } else if (typeof obj === 'object' && obj !== null) {
        const ul = document.createElement('ul');
        for (const [key, value] of Object.entries(obj)) {
            const li = document.createElement('li');
            if (typeof value === 'object' && value !== null) {
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                summary.textContent = key;
                details.appendChild(summary);
                render(details, value);
                li.appendChild(details);
            } else {
                li.textContent = key + ': ' + value;
            }
            ul.appendChild(li);
        }
        container.appendChild(ul);
    } else {
        container.textContent = obj;
    }
}
render(document.getElementById('json-tree'), data);
</script>
{% endif %}
{% endblock %}
