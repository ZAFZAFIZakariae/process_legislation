{% extends "base.html" %}
{% block title %}Legal Documents{% endblock %}
{% block content %}
<h1>Legal Documents</h1>
<section class="card">
    <input type="text" id="search" placeholder="Search files..." />
    <ul class="file-list" id="file-list">
    {% for f in files %}
        <li><a class="button" href="{{ url_for('view_legal_documents', file=f) }}">{{ f }}</a></li>
    {% else %}
        <li>No JSON files found.</li>
    {% endfor %}
    </ul>
</section>
{% if text %}
<section class="card">
    <h2>{{ selected }}</h2>
    <div id="document-text" style="white-space: pre-wrap;">{{ text }}</div>
</section>
{% if decision %}
<section class="card" id="decision-section">
    <h2>Decision</h2>
    {% for key, items in decision.items() %}
        <h3>{{ key.replace('_', ' ') }}</h3>
        <ul>
        {% for item in items %}
            <li class="decision-item">{{ item }}</li>
        {% endfor %}
        </ul>
    {% endfor %}
</section>
{% endif %}
<section class="card">
    <a class="button" href="{{ url_for('edit_legal_document', file=selected) }}">Edit annotations</a>
    <a class="button" href="{{ url_for('edit_decision', file=selected) }}">Edit decisions</a>
</section>
<div id="popup" style="display:none;position:fixed;top:10%;left:10%;width:80%;max-height:80%;overflow:auto;background:white;border:1px solid #888;padding:10px;z-index:1000;">
    <button id="popup-close" style="float:left;">X</button>
    <div id="popup-content"></div>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
const searchInput = document.getElementById('search');
searchInput && searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    document.querySelectorAll('#file-list li').forEach(li => {
        const text = li.textContent.toLowerCase();
        li.style.display = text.includes(query) ? '' : 'none';
    });
});
{% if text %}
const entitiesData = {{ entities | tojson | default('null', true) }};
const entityMap = {};
if (entitiesData) {
    entitiesData.forEach(e => { entityMap[e.id] = e; });
}
function escapeHtml(str) {
    return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function formatText(value) {
    if (typeof value !== 'string') return escapeHtml(String(value));
    return value.replace(/<([^,<>]+), id:([^>]+)>/g, (_m, txt, id) => {
        const ent = entityMap[id] || {};
        const attrs = ['class="entity-link"', 'href="#"'];
        const popup = [];
        if (ent.text) popup.push(`<p>${escapeHtml(ent.text)}</p>`);
        if (ent.articles && ent.articles.length) {
            popup.push('<ul>' + ent.articles.map(r => `<li>${escapeHtml(r)}</li>`).join('') + '</ul>');
        } else {
            ['references','relations'].forEach(key => {
                const items = ent[key];
                if (items && items.length) {
                    popup.push('<ul>' + items.map(r => `<li>${escapeHtml(r)}</li>`).join('') + '</ul>');
                }
            });
        }
        if (popup.length) attrs.push(`data-popup="${popup.join('')}"`);
        return `<a ${attrs.join(' ')}>${escapeHtml(txt)}</a>`;
    });
}
const docDiv = document.getElementById('document-text');
docDiv.innerHTML = formatText(docDiv.textContent);
document.querySelectorAll('.decision-item').forEach(li => {
    li.innerHTML = formatText(li.textContent);
});
document.addEventListener('click', function(ev) {
    const link = ev.target.closest('.entity-link');
    if (!link) return;
    const popup = link.dataset.popup;
    if (popup) {
        document.getElementById('popup-content').innerHTML = popup;
        document.getElementById('popup').style.display = 'block';
    }
    ev.preventDefault();
});
document.getElementById('popup-close').addEventListener('click', () => {
    document.getElementById('popup').style.display = 'none';
});
{% endif %}
</script>
{% endblock %}

