<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moroccan Legislation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
<header>
    <div class="logo">Legal AI Assistant</div>
    <nav>
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('index') }}">Entities</a>
        <a href="{{ url_for('extract_structure') }}">Structure</a>
        <a href="{{ url_for('parse_decision_route') }}">Decision</a>
        <a href="{{ url_for('run_query') }}">SQL</a>
        <a href="{{ url_for('view_legislation') }}">Moroccan Legislation</a>
    </nav>
</header>
<main class="container">
    <h1>Moroccan Legislation</h1>
    <section class="card">
        <input type="text" id="search" placeholder="Search files..." />
        <ul class="file-list" id="file-list">
        {% for f in files %}
            <li><a class="button" href="{{ url_for('view_legislation', file=f) }}">{{ f }}</a></li>
        {% else %}
            <li>No JSON files found.</li>
        {% endfor %}
        </ul>
    </section>
    <script>
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('#file-list li').forEach(li => {
            const text = li.textContent.toLowerCase();
            li.style.display = text.includes(query) ? '' : 'none';
        });
    });
    </script>
    {% if data %}
    <section class="card">
        <h2>{{ selected }}</h2>
        <div id="json-tree" class="json-tree"></div>
    </section>
    <script>
    const data = {{ data | tojson }};
    const entities = {{ ner_entities | default([]) | tojson | safe }};
    function escapeRegExp(string){return string.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');}
    function highlightEntities(text){
        let html=text;
        entities.forEach(ent=>{
            const pattern=new RegExp(escapeRegExp(ent.text),'g');
            html=html.replace(pattern,`<span class="ner-span"><mark class="entity-mark" title="${ent.type}">${ent.text}</mark></span>`);
        });
        return html;
    }
    function render(container, obj) {
        if (Array.isArray(obj)) {
            const ul = document.createElement('ul');
            obj.forEach(item => {
                const li = document.createElement('li');
                render(li, item);
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else if (typeof obj === 'object' && obj !== null) {
            const ul = document.createElement('ul');
            Object.keys(obj).sort().forEach(key => {
                const value = obj[key];
                const li = document.createElement('li');
                if (typeof value === 'object' && value !== null) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.classList.add('json-key');
                    summary.textContent = key;
                    details.appendChild(summary);
                    render(details, value);
                    li.appendChild(details);
                } else {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key';
                    keySpan.textContent = key + ': ';
                    const valSpan = document.createElement('span');
                    valSpan.className = 'json-value';
                    valSpan.innerHTML = highlightEntities(String(value));
                    li.appendChild(keySpan);
                    li.appendChild(valSpan);
                }
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else {
            const valSpan = document.createElement('span');
            valSpan.className = 'json-value';
            valSpan.innerHTML = highlightEntities(String(obj));
            container.appendChild(valSpan);
        }
    }
    render(document.getElementById('json-tree'), data);
    </script>
    {% endif %}
</main>
</body>
</html>
