<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moroccan Legislation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
<header>
    <div class="logo">Legal AI Assistant</div>
    <nav>
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('index') }}">Entities</a>
        <a href="{{ url_for('extract_structure') }}">Structure</a>
        <a href="{{ url_for('parse_decision_route') }}">Decision</a>
        <a href="{{ url_for('run_query') }}">SQL</a>
        <a href="{{ url_for('view_legislation') }}">Moroccan Legislation</a>
    </nav>
</header>
<main class="container">
    <h1>Moroccan Legislation</h1>
    <section class="card">
        <input type="text" id="search" placeholder="Search files..." />
        <ul class="file-list" id="file-list">
        {% for f in files %}
            <li><a class="button" href="{{ url_for('view_legislation', file=f) }}">{{ f }}</a></li>
        {% else %}
            <li>No JSON files found.</li>
        {% endfor %}
        </ul>
    </section>
    <script>
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('#file-list li').forEach(li => {
            const text = li.textContent.toLowerCase();
            li.style.display = text.includes(query) ? '' : 'none';
        });
    });
    </script>
    {% if data %}
    <section class="card">
        <h2>{{ selected }}</h2>
        <div id="json-tree" class="json-tree"></div>
    </section>
    {% if entities %}
    <section class="card">
        <h2>Entities</h2>
        <ul class="entity-list">
        {% for ent in entities %}
            <li>
                <details>
                    <summary id="entity-{{ ent.id }}">{{ ent.text }} (id: {{ ent.id }})</summary>
                    {% if ent.relations %}
                        <p><strong>Relations</strong></p>
                        <ul>
                        {% for r in ent.relations %}<li>{{ r }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                    {% if ent.references %}
                        <p><strong>References</strong></p>
                        <ul>
                        {% for ref in ent.references %}<li>{{ ref }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </details>
            </li>
        {% endfor %}
        </ul>
    </section>
    {% endif %}
    <script>
    const data = {{ data | tojson }};
    const entitiesData = {{ entities | tojson | default('null', true) }};
    const entityMap = {};
    if (entitiesData) {
        entitiesData.forEach(e => { entityMap[e.id] = e; });
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function(c) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
        });
    }

    function formatText(value) {
        if (typeof value !== 'string') {
            return escapeHtml(String(value));
        }
        return value.replace(/<([^,<>]+), id:(\d+)>/g, function(_m, txt, id) {
            const ent = entityMap[id];
            const bold = `<strong>${escapeHtml(txt)}</strong>`;
            if (ent && ((ent.relations && ent.relations.length) || (ent.references && ent.references.length))) {
                return `<a href="#entity-${id}" class="entity-link">${bold}</a>`;
            }
            return bold;
        });
    }

    function render(container, obj) {
        if (Array.isArray(obj)) {
            const ul = document.createElement('ul');
            obj.forEach((item, idx) => {
                const li = document.createElement('li');
                if (typeof item === 'object' && item !== null) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.classList.add('json-key');
                    let label = item.text || item.title || item.number || item.id || idx;
                    if (typeof label === 'string' && label.length > 40) {
                        label = label.slice(0, 40) + '...';
                    }
                    summary.textContent = label;
                    details.appendChild(summary);
                    render(details, item);
                    li.appendChild(details);
                } else {
                    render(li, item);
                }
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else if (typeof obj === 'object' && obj !== null) {
            const ul = document.createElement('ul');
            Object.keys(obj).sort().forEach(key => {
                const value = obj[key];
                const li = document.createElement('li');
                if (typeof value === 'object' && value !== null) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.classList.add('json-key');
                    summary.textContent = key;
                    details.appendChild(summary);
                    render(details, value);
                    li.appendChild(details);
                } else {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key';
                    keySpan.textContent = key + ': ';
                    const valSpan = document.createElement('span');
                    valSpan.className = 'json-value';
                    valSpan.innerHTML = formatText(value);
                    li.appendChild(keySpan);
                    li.appendChild(valSpan);
                }
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else {
            const valSpan = document.createElement('span');
            valSpan.className = 'json-value';
            valSpan.innerHTML = formatText(obj);
            container.appendChild(valSpan);
        }
    }
    render(document.getElementById('json-tree'), data);
    </script>
    {% endif %}
</main>
</body>
</html>
