<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moroccan Legislation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
<header>
    <div class="logo">Legal AI Assistant</div>
    <nav>
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('index') }}">Entities</a>
        <a href="{{ url_for('extract_structure') }}">Structure</a>
        <a href="{{ url_for('parse_decision_route') }}">Decision</a>
        <a href="{{ url_for('run_query') }}">SQL</a>
        <a href="{{ url_for('view_legislation') }}">Moroccan Legislation</a>
    </nav>
</header>
<main class="container">
    <h1>Moroccan Legislation</h1>
    <section class="card">
        <input type="text" id="search" placeholder="Search files..." />
        <ul class="file-list" id="file-list">
        {% for f in files %}
            <li><a class="button" href="{{ url_for('view_legislation', file=f) }}">{{ f }}</a></li>
        {% else %}
            <li>No JSON files found.</li>
        {% endfor %}
        </ul>
    </section>
    <script>
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('#file-list li').forEach(li => {
            const text = li.textContent.toLowerCase();
            li.style.display = text.includes(query) ? '' : 'none';
        });
    });
    </script>
    {% if data %}
    <section class="card">
        <h2>{{ selected }}</h2>
        <div id="json-tree" class="json-tree"></div>
    </section>
    {% if entities %}
    <section class="card">
        <h2>Entities</h2>
        <ul class="entity-list">
        {% for ent in entities %}
            <li>
                <details>
                    <summary id="entity-{{ ent.id }}">{{ ent.text }} (id: {{ ent.id }})</summary>
                    {% if ent.relations %}
                        <p><strong>Relations</strong></p>
                        <ul>
                        {% for r in ent.relations %}<li>{{ r }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                    {% if ent.references %}
                        <p><strong>References</strong></p>
                        <ul>
                        {% for ref in ent.references %}<li>{{ ref }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </details>
            </li>
        {% endfor %}
        </ul>
    </section>
    {% endif %}
    <div id="popup" style="display:none;position:fixed;top:10%;left:10%;width:80%;max-height:80%;overflow:auto;background:white;border:1px solid #888;padding:10px;z-index:1000;">
        <button id="popup-close" style="float:left;">X</button>
        <div id="popup-content"></div>
    </div>
    <script>
    const data = {{ data | tojson }};
    const entitiesData = {{ entities | tojson | default('null', true) }};
    const entityMap = {};
    const articleTargets = {};
    if (entitiesData) {
        entitiesData.forEach(e => {
            entityMap[e.id] = e;
            if (e.type === 'ARTICLE') {
                const num = canonicalNum(e.normalized || e.text);
                if (num) {
                    articleTargets[e.id] = `node-${num}`;
                }
            }
        });
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function(c) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
        });
    }

    function canonicalNum(value) {
        if (!value) return null;
        const trans = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
        let s = String(value).replace(/[٠-٩]/g, d => trans[d]);
        const m = s.match(/\d+(?:[./]+[^\d]*\d+)*/);
        if (!m) return null;
        const digits = m[0].match(/\d+/g);
        const seps = m[0].match(/[./]+/g) || [];
        let result = digits[0];
        for (let i = 1; i < digits.length; i++) {
            result += seps[i-1][0] + digits[i];
        }
        return result;
    }

    function formatText(value) {
        if (typeof value !== 'string') {
            return escapeHtml(String(value));
        }
        return value.replace(/<([^,<>]+), id:(\d+)>/g, function(_m, txt, id) {
            const ent = entityMap[id];
            const bold = `<strong>${escapeHtml(txt)}</strong>`;
            const target = articleTargets[id];
            if (target) {
                return `<a href="#${target}" class="entity-link" data-target="${target}">${bold}</a>`;
            }
            if (ent && ((ent.relations && ent.relations.length) || (ent.references && ent.references.length))) {
                const info = [...(ent.relations || []), ...(ent.references || [])].join('<br/>');
                return `<a href="javascript:void(0)" class="entity-link" data-popup="${escapeHtml(info)}">${bold}</a>`;
            }
            return bold;
        });
    }

    function renderNode(node, container) {
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.classList.add('json-key');
        let label = '';
        if (node.type) label += escapeHtml(node.type);
        if (node.number) {
            label += (label ? ' ' : '') + escapeHtml(node.number);
            const num = canonicalNum(node.number);
            if (num) summary.id = `node-${num}`;
        }
        if (node.title) {
            label += (label ? ': ' : '') + formatText(node.title);
        }
        summary.innerHTML = label || formatText(node.text || '');
        details.appendChild(summary);

        if (node.text) {
            const textDiv = document.createElement('div');
            textDiv.className = 'json-value';
            textDiv.innerHTML = formatText(node.text);
            details.appendChild(textDiv);
        }

        if (Array.isArray(node.children) && node.children.length) {
            const ul = document.createElement('ul');
            node.children.forEach(child => {
                const li = document.createElement('li');
                if (child && typeof child === 'object') {
                    renderNode(child, li);
                } else {
                    render(li, child);
                }
                ul.appendChild(li);
            });
            details.appendChild(ul);
        }

        container.appendChild(details);
    }

    function render(container, obj) {
        if (Array.isArray(obj)) {
            const ul = document.createElement('ul');
            obj.forEach(item => {
                const li = document.createElement('li');
                if (item && typeof item === 'object' && (item.type || item.children || item.title || item.number || item.text)) {
                    renderNode(item, li);
                } else {
                    render(li, item);
                }
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else if (obj && typeof obj === 'object') {
            if (obj.type || obj.children || obj.title || obj.number || obj.text) {
                renderNode(obj, container);
            } else {
                const ul = document.createElement('ul');
                Object.keys(obj).sort().forEach(key => {
                    const value = obj[key];
                    const li = document.createElement('li');
                    if (value && typeof value === 'object') {
                        const details = document.createElement('details');
                        const summary = document.createElement('summary');
                        summary.classList.add('json-key');
                        summary.textContent = key;
                        details.appendChild(summary);
                        render(details, value);
                        li.appendChild(details);
                    } else {
                        const keySpan = document.createElement('span');
                        keySpan.className = 'json-key';
                        keySpan.textContent = key + ': ';
                        const valSpan = document.createElement('span');
                        valSpan.className = 'json-value';
                        valSpan.innerHTML = formatText(value);
                        li.appendChild(keySpan);
                        li.appendChild(valSpan);
                    }
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            }
        } else {
            const valSpan = document.createElement('span');
            valSpan.className = 'json-value';
            valSpan.innerHTML = formatText(obj);
            container.appendChild(valSpan);
        }
    }
    render(document.getElementById('json-tree'), data);

    document.querySelectorAll('.entity-link').forEach(link => {
        link.addEventListener('click', ev => {
            ev.preventDefault();
            const target = link.getAttribute('data-target');
            if (target) {
                const el = document.getElementById(target);
                if (el) {
                    let parent = el.closest('details');
                    while (parent) {
                        parent.open = true;
                        parent = parent.parentElement.closest('details');
                    }
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                const content = link.getAttribute('data-popup');
                if (content) {
                    const popup = document.getElementById('popup');
                    const pc = document.getElementById('popup-content');
                    if (pc) pc.innerHTML = content;
                    if (popup) popup.style.display = 'block';
                }
            }
        });
    });

    document.getElementById('popup-close').addEventListener('click', () => {
        document.getElementById('popup').style.display = 'none';
    });
    </script>
    {% endif %}
</main>
</body>
</html>
